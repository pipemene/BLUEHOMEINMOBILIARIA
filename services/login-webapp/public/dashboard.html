<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard – Blue Home</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="/config.js"></script>
  <script src="/guard.js"></script>
</head>
<body>
  <div class="header">
    <div class="brand">
      <div class="logo">BH</div>
      <div>
        <div class="title">Dashboard Blue Home</div>
        <div class="subtitle">Accesos unificados por rol</div>
      </div>
    </div>
    <button class="btn" onclick="logout()">Cerrar sesión</button>
  </div>
  <main class="main">
    <section class="card hero">
      <h1>Hola, <span id="user-name"></span></h1>
      <p>
        Este tablero concentra los módulos internos y servicios disponibles para tu rol. Utiliza los accesos rápidos para ir a
        cada aplicación o consulta la sección de ayuda si necesitas actualizar permisos.
      </p>
      <div class="kv" id="user-info"></div>
    </section>

    <section class="card">
      <h2 style="margin-top:0">Aplicaciones disponibles</h2>
      <p style="margin-bottom:18px">
        Los accesos se calculan automáticamente según la configuración de roles del equipo.
      </p>
      <div id="apps-grid" class="apps-grid" aria-live="polite"></div>
    </section>

    <section class="card">
      <h2 style="margin-top:0">Ayuda rápida</h2>
      <ul>
        <li>
          <strong>Actualizar credenciales</strong>
          <p>Edita tu usuario o rol desde la hoja <a href="https://docs.google.com/spreadsheets/d/1VizQYx8-vDENf3_FkQ2fYAdpC993cpR5NmlcSUg2J6w/edit?usp=sharing" target="_blank" rel="noopener">Blue Home – Usuarios</a>.</p>
        </li>
        <li>
          <strong>Problemas de acceso</strong>
          <p>Valida que el módulo aparezca aquí. Si falta, revisa tu rol o contacta a Administración.</p>
        </li>
        <li>
          <strong>¿Olvidaste cerrar sesión?</strong>
          <p>Puedes cerrar sesión desde cualquier módulo con el botón “Cerrar sesión” del encabezado.</p>
        </li>
      </ul>
    </section>
  </main>
  <div class="footer">© Blue Home Inmobiliaria</div>
  <script>
    const MODULES = [
      {
        id: 'admin',
        title: 'Administración',
        description: 'Visión general, métricas corporativas y accesos estratégicos.',
        href: '/admin',
        roles: ['superadmin']
      },
      {
        id: 'arriendos',
        title: 'Arriendos',
        description: 'Propiedades, contratos, renovaciones y seguimiento de inquilinos.',
        href: '/arriendos',
        roles: ['superadmin', 'arriendos']
      },
      {
        id: 'tecnico',
        title: 'Técnico',
        description: 'Órdenes de trabajo, cuadrillas y planificación en terreno.',
        href: '/tecnico',
        roles: ['superadmin', 'tecnico']
      },
      {
        id: 'contabilidad',
        title: 'Contabilidad',
        description: 'Pagos, conciliaciones bancarias y flujo de caja.',
        href: '/contabilidad',
        roles: ['superadmin', 'contabilidad']
      },
      {
        id: 'reparaciones',
        title: 'Reparaciones',
        description: 'Casos de postventa, avances y entregas finales.',
        href: '/reparaciones',
        roles: ['superadmin', 'reparaciones']
      }
    ];

    const auth = requireAuth();
    if (auth) {
      const user = auth.user || {};
      const canonical = (window.canonicalRole ? window.canonicalRole(user.role || auth.payload.role) : (user.role || auth.payload.role || '')) || '';
      const nameEl = document.getElementById('user-name');
      const infoEl = document.getElementById('user-info');
      const appsGrid = document.getElementById('apps-grid');
      const roleLabel = canonical ? canonical.charAt(0).toUpperCase() + canonical.slice(1) : 'Sin rol';
      const displayName = user.username || auth.payload.sub || 'usuario';

      if (nameEl) {
        nameEl.textContent = displayName;
      }

      if (infoEl) {
        infoEl.innerHTML = `
          <label>Usuario</label><div>${displayName}</div>
          <label>Rol</label><div>${roleLabel}</div>
          <label>Expira</label><div>${new Date(auth.payload.exp * 1000).toLocaleString()}</div>
        `;
      }

      if (appsGrid) {
        const allowed = MODULES.filter((module) => {
          if (!module.roles || !module.roles.length) return true;
          return module.roles.includes(canonical);
        });

        if (!allowed.length) {
          appsGrid.innerHTML = '<p class="empty">No hay módulos asociados a tu rol.</p>';
        } else {
          appsGrid.innerHTML = allowed.map((module) => {
            return `
              <article class="app-card">
                <header>
                  <span class="app-card__tag">${module.id}</span>
                  <h3>${module.title}</h3>
                </header>
                <p>${module.description}</p>
                <div class="app-card__actions">
                  <a class="btn" href="${module.href}">Ingresar</a>
                </div>
              </article>
            `;
          }).join('');
        }
      }
    }
  </script>
</body>
</html>
