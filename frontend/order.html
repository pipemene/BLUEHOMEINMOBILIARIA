<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Blue Home | Detalle de orden</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="app-shell">
    <main class="app-card">
      <section class="app-card__left">
        <header class="navbar">
          <div class="logo-mark">
            <div class="logo-mark__chip">BH</div>
            <div class="logo-mark__text">
              <span class="logo-mark__title">BLUE HOME</span>
              <span class="logo-mark__subtitle">Orden de servicio</span>
            </div>
          </div>
          <nav class="nav-links">
            <a href="./dashboard.html">Dashboard</a>
            <a href="./orders.html" class="active">Órdenes</a>
            <a href="./tecnicos.html">Técnicos</a>
            <a href="./facturacion.html">Facturación</a>
          </nav>
        </header>

        <section style="margin-top: 4px;">
          <div class="badge">
            <span class="badge-dot"></span>
            <span>Detalle y actualización de orden</span>
          </div>

          <div style="margin-top: 10px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
            <div>
              <h1 class="page-title" id="orderCode">Orden</h1>
              <p class="page-subtitle" id="orderSubtitle">
                Cargando datos...
              </p>
            </div>
            <button class="button button--outline" onclick="window.location.href='orders.html'">
              ← Volver a listado
            </button>
          </div>

          <form class="form" id="orderForm">
            <div class="field">
              <label for="inmuebleDireccion">Inmueble / dirección</label>
              <input class="input" id="inmuebleDireccion" />
            </div>

            <div class="field">
              <label for="inmuebleCodigo">Código de inmueble</label>
              <input class="input" id="inmuebleCodigo" />
            </div>

            <div class="field">
              <label for="arrendatarioNombre">Arrendatario</label>
              <input class="input" id="arrendatarioNombre" />
            </div>

            <div class="field">
              <label for="arrendatarioTelefono">Teléfono arrendatario</label>
              <input class="input" id="arrendatarioTelefono" />
            </div>

            <div class="field">
              <label for="tipoOrden">Tipo de orden</label>
              <select class="select" id="tipoOrden">
                <option value="reparacion">Reparación</option>
                <option value="mantenimiento">Mantenimiento</option>
                <option value="inspeccion">Inspección</option>
              </select>
            </div>

            <div class="field">
              <label for="descripcion">Descripción del daño / trabajo</label>
              <textarea id="descripcion"></textarea>
            </div>

            <div class="field">
              <label for="status">Estado</label>
              <select class="select" id="status">
                <option value="pendiente">Pendiente</option>
                <option value="en_proceso">En proceso</option>
                <option value="cerrada">Cerrada</option>
              </select>
            </div>

            <div class="field">
              <label for="tecnicoAsignado">Técnico asignado</label>
              <input class="input" id="tecnicoAsignado" />
            </div>

            <div class="field">
              <label for="fechaProgramada">Fecha y hora programada</label>
              <input class="input" id="fechaProgramada" type="datetime-local" />
            </div>

            <div class="button-row button-row-right">
              <button class="button button--outline" type="button" onclick="loadOrder()">
                Deshacer cambios
              </button>
              <button class="button" type="submit">
                Guardar cambios
              </button>
            </div>
          </form>

          <div class="notice">
            <strong>Historial y evidencias:</strong> luego se agrega una sección para mostrar historial,
            fotos, firmas y el PDF final de la orden para facturación.
          </div>
        </section>
      </section>

      <aside class="app-card__right">
        <h2 style="font-size:16px; margin-bottom:10px;">Estado rápido</h2>
        <p style="font-size:13px; color: var(--muted);">
          Más adelante aquí podemos mostrar tiempo desde la creación, cantidad de visitas,
          y si ya tiene soportes completos.
        </p>
      </aside>
    </main>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8080/api';
    const params = new URLSearchParams(window.location.search);
    const ORDER_ID = params.get('id');

    if (!ORDER_ID) {
      alert('No se encontró el ID de la orden.');
      window.location.href = 'orders.html';
    }

    async function loadOrder() {
      try {
        const res = await fetch(`${API_BASE_URL}/orders/${ORDER_ID}`, {
          headers: {
            'Content-Type': 'application/json'
          }
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.message || 'Error');
        const o = data.data;

        document.getElementById('orderCode').textContent = o.code || 'Orden';
        document.getElementById('orderSubtitle').textContent =
          (o.inmuebleDireccion || 'Sin dirección') + ' · ' + (o.arrendatarioNombre || 'Sin arrendatario');

        document.getElementById('inmuebleDireccion').value = o.inmuebleDireccion || '';
        document.getElementById('inmuebleCodigo').value = o.inmuebleCodigo || '';
        document.getElementById('arrendatarioNombre').value = o.arrendatarioNombre || '';
        document.getElementById('arrendatarioTelefono').value = o.arrendatarioTelefono || '';
        document.getElementById('tipoOrden').value = o.tipoOrden || 'reparacion';
        document.getElementById('descripcion').value = o.descripcion || '';
        document.getElementById('status').value = o.status || 'pendiente';
        document.getElementById('tecnicoAsignado').value = o.tecnicoAsignado || '';
        document.getElementById('fechaProgramada').value = o.fechaProgramada
          ? new Date(o.fechaProgramada).toISOString().slice(0,16)
          : '';
      } catch (err) {
        console.error(err);
        alert('Error al cargar la orden');
      }
    }

    document.getElementById('orderForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const payload = {
        inmuebleDireccion: document.getElementById('inmuebleDireccion').value,
        inmuebleCodigo: document.getElementById('inmuebleCodigo').value,
        arrendatarioNombre: document.getElementById('arrendatarioNombre').value,
        arrendatarioTelefono: document.getElementById('arrendatarioTelefono').value,
        tipoOrden: document.getElementById('tipoOrden').value,
        descripcion: document.getElementById('descripcion').value,
        status: document.getElementById('status').value,
        tecnicoAsignado: document.getElementById('tecnicoAsignado').value,
        fechaProgramada: document.getElementById('fechaProgramada').value || null,
        _historial: {
          usuario: 'Pipe',
          accion: 'actualizacion',
          detalle: 'Actualización desde interfaz web'
        }
      };

      try {
        const res = await fetch(`${API_BASE_URL}/orders/${ORDER_ID}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.message || 'Error');
        alert('Orden actualizada correctamente.');
        loadOrder();
      } catch (err) {
        console.error(err);
        alert('Error al guardar los cambios.');
      }
    });

    loadOrder();
  </script>
</body>
</html>
