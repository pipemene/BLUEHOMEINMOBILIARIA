<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Blue Home | Órdenes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="app-shell">
    <main class="app-card">
      <section class="app-card__left">
        <header class="navbar">
          <div class="logo-mark">
            <div class="logo-mark__chip">BH</div>
            <div class="logo-mark__text">
              <span class="logo-mark__title">BLUE HOME</span>
              <span class="logo-mark__subtitle">Gestor de órdenes</span>
            </div>
          </div>
          <nav class="nav-links">
            <a href="./dashboard.html">Dashboard</a>
            <a href="./orders.html" class="active">Órdenes</a>
            <a href="./tecnicos.html">Técnicos</a>
            <a href="./facturacion.html">Facturación</a>
          </nav>
        </header>

        <section style="margin-top: 6px;">
          <div class="badge">
            <span class="badge-dot"></span>
            <span>Órdenes de mantenimiento y reparaciones</span>
          </div>

          <div style="margin-top: 12px; display:flex; justify-content:space-between; align-items:flex-end; gap:8px;">
            <div>
              <h1 class="page-title">Órdenes</h1>
              <p class="page-subtitle">
                Todas las órdenes: pendientes, en proceso y cerradas.
              </p>
            </div>
            <button class="button" onclick="window.location.href='order-nueva.html'">
              Nueva orden
              <span style="font-size: 18px;">＋</span>
            </button>
          </div>

          <div class="table-wrapper">
            <div class="table-header">
              <div class="filters-row">
                <select id="filterStatus" class="select">
                  <option value="">Estado: todos</option>
                  <option value="pendiente">Pendiente</option>
                  <option value="en_proceso">En proceso</option>
                  <option value="cerrada">Cerrada</option>
                </select>
                <input id="filterCodigo" class="input" placeholder="Código inmueble..." />
                <input id="filterTecnico" class="input" placeholder="Técnico asignado..." />
              </div>
              <button class="button button--ghost" onclick="loadOrders()">Aplicar filtros</button>
            </div>

            <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th>Código orden</th>
                    <th>Inmueble</th>
                    <th>Arrendatario</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Técnico</th>
                    <th>Programada</th>
                  </tr>
                </thead>
                <tbody id="ordersBody">
                  <tr>
                    <td colspan="7" style="text-align:center; padding: 18px; color: var(--muted);">
                      Cargando órdenes desde el backend...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </section>

      <aside class="app-card__right">
        <h2 style="font-size:17px; margin-bottom:10px;">Cómo usar esta vista</h2>
        <ol style="font-size: 13px; color: var(--muted); padding-left: 18px; display:flex; flex-direction:column; gap:6px;">
          <li>Filtra por estado para ver solo pendientes, en proceso o cerradas.</li>
          <li>Busca por código de inmueble para ver todo lo de un apartamento.</li>
          <li>Haz clic en una fila para abrir el detalle de la orden.</li>
        </ol>

        <div class="card" style="margin-top:14px;">
          <div class="card-tag-row">
            <span class="card-title">Próximo módulo</span>
            <span class="badge-soft">Drive / PDF</span>
          </div>
          <p class="card-desc">
            Después conectamos esta lista a Google Drive para ver soportes
            (fotos, actas, facturas) directamente desde aquí.
          </p>
        </div>
      </aside>
    </main>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8080/api';

    async function loadOrders() {
      const tbody = document.getElementById('ordersBody');
      const status = document.getElementById('filterStatus').value;
      const codigo = document.getElementById('filterCodigo').value.trim();
      const tecnico = document.getElementById('filterTecnico').value.trim();

      const params = new URLSearchParams();
      if (status) params.append('status', status);
      if (codigo) params.append('inmuebleCodigo', codigo);
      if (tecnico) params.append('tecnicoAsignado', tecnico);

      const url = `${API_BASE_URL}/orders?${params.toString()}`;

      try {
        const res = await fetch(url, {
          headers: {
            'Content-Type': 'application/json'
          }
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.message || 'Error');

        const orders = data.data || [];
        if (!orders.length) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 16px; color: var(--muted);">No se encontraron órdenes con esos filtros.</td></tr>';
          return;
        }

        tbody.innerHTML = orders
          .slice()
          .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))
          .map(o => `
            <tr onclick="window.location.href='order.html?id=${encodeURIComponent(o.id)}'">
              <td>${o.code}</td>
              <td>${o.inmuebleDireccion || '-'}</td>
              <td>${o.arrendatarioNombre || '-'}</td>
              <td>${o.tipoOrden || '-'}</td>
              <td>
                <span class="status-pill ${o.status === 'pendiente' ? 'status-pill--pending' : ''}">
                  ${o.status || 'pendiente'}
                </span>
              </td>
              <td>${o.tecnicoAsignado || '-'}</td>
              <td>${o.fechaProgramada ? new Date(o.fechaProgramada).toLocaleString('es-CO') : '-'}</td>
            </tr>
          `).join('');
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 16px; color: var(--danger);">Error al cargar las órdenes.</td></tr>';
      }
    }

    loadOrders();
  </script>
</body>
</html>
