<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Blue Home | Dashboard Gestor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="app-shell">
    <main class="app-card">
      <section class="app-card__left">
        <header class="navbar">
          <div class="logo-mark">
            <div class="logo-mark__chip">BH</div>
            <div class="logo-mark__text">
              <span class="logo-mark__title">BLUE HOME</span>
              <span class="logo-mark__subtitle">Gestor de procesos · Panel</span>
            </div>
          </div>
          <nav class="nav-links">
            <a href="./dashboard.html" class="active">Dashboard</a>
            <a href="./orders.html">Órdenes</a>
            <a href="./tecnicos.html">Técnicos</a>
            <a href="./facturacion.html">Facturación</a>
          </nav>
        </header>

        <section style="margin-top: 6px;">
          <div class="badge">
            <span class="badge-dot"></span>
            <span>Vista global de operaciones</span>
          </div>

          <div style="margin-top: 12px;">
            <h1 class="page-title">Resumen operativo</h1>
            <p class="page-subtitle">
              Pulso rápido de las órdenes, técnicos y trabajos cerrados.
            </p>
          </div>

          <div class="cards-grid" id="summaryCards">
            <article class="card">
              <div class="card-tag-row">
                <h2 class="card-title">Órdenes abiertas</h2>
                <span class="badge-soft">Reparaciones</span>
              </div>
              <div class="card-metric" id="metricAbiertas">−</div>
              <p class="card-desc">Órdenes en estado pendiente o en proceso.</p>
            </article>

            <article class="card">
              <div class="card-tag-row">
                <h2 class="card-title">Órdenes cerradas hoy</h2>
                <span class="badge-soft">Cerradas</span>
              </div>
              <div class="card-metric" id="metricCerradas">−</div>
              <p class="card-desc">Mantenimientos con visita y firma finalizada.</p>
            </article>

            <article class="card">
              <div class="card-tag-row">
                <h2 class="card-title">Técnicos activos</h2>
                <span class="badge-soft">Equipo</span>
              </div>
              <div class="card-metric" id="metricTecnicos">−</div>
              <p class="card-desc">Técnicos con órdenes asignadas hoy.</p>
            </article>
          </div>

          <div class="table-wrapper">
            <div class="table-header">
              <div>
                <strong style="font-size: 13px;">Órdenes recientes</strong>
                <p class="page-subtitle" style="margin-top: 2px;">
                  Últimas órdenes creadas o actualizadas.
                </p>
              </div>
              <a href="./orders.html" class="button button--outline" style="margin-top: 0;">Ver todas</a>
            </div>
            <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Inmueble</th>
                    <th>Arrendatario</th>
                    <th>Estado</th>
                    <th>Técnico</th>
                    <th>Actualizada</th>
                  </tr>
                </thead>
                <tbody id="recentOrdersBody">
                  <tr>
                    <td colspan="6" style="text-align:center; color: var(--muted); padding: 20px;">
                      Cargando órdenes desde el backend...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

        </section>
      </section>

      <aside class="app-card__right">
        <div style="display:flex; flex-direction:column; gap:12px;">
          <div class="badge">
            <span class="badge-dot"></span>
            <span>Diseñado para Blue Home</span>
          </div>

          <h2 style="font-size: 18px; margin-top: 4px;">
            Flujo: reporte → orden → técnico → firma → factura.
          </h2>

          <p style="font-size: 13px; color: var(--muted);">
            Esta tarjeta lateral puede reemplazarse luego por métricas más pesadas:
            tiempos promedio, SLA por edificio, rendimiento por técnico, etc.
          </p>

          <div class="card">
            <div class="card-tag-row">
              <h3 class="card-title">Siguiente paso</h3>
              <span class="badge-soft">Integración</span>
            </div>
            <p class="card-desc">
              Cuando quede estable el front, cada bloque se conecta a la API en Railway
              (<code>/api/orders</code> y lo demás).
            </p>
          </div>

          <p class="helper-text">
            A futuro este diseño se puede reusar para un portal de propietarios con filtros
            por inmueble y estado de reparaciones.
          </p>
        </div>
      </aside>
    </main>
  </div>

  <script>
    const API_BASE_URL = 'https://bluehomeinmobiliaria-production.up.railway.app';
    const API_KEY = 'Blu3h0m32016#';

    async function loadDashboard() {
      const tbody = document.getElementById('recentOrdersBody');
      try {
        const res = await fetch(`${API_BASE_URL}/api/orders`, {
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': API_KEY
          }
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.message || 'Error al cargar');

        const orders = data.data || [];
        document.getElementById('metricAbiertas').textContent =
          orders.filter(o => o.status !== 'cerrada').length;
        document.getElementById('metricCerradas').textContent =
          orders.filter(o => o.status === 'cerrada').length;
        document.getElementById('metricTecnicos').textContent =
          new Set(orders.map(o => o.tecnicoAsignado).filter(Boolean)).size;

        if (!orders.length) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:16px; color: var(--muted);">Aún no hay órdenes creadas.</td></tr>';
          return;
        }

        const latest = orders
          .slice()
          .sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt))
          .slice(0, 8);

        tbody.innerHTML = latest.map(o => `
          <tr onclick="window.location.href='order.html?id=${encodeURIComponent(o.id)}'">
            <td>${o.code}</td>
            <td>${o.inmuebleDireccion || '-'}</td>
            <td>${o.arrendatarioNombre || '-'}</td>
            <td>
              <span class="status-pill ${o.status === 'pendiente' ? 'status-pill--pending' : ''}">
                ${o.status || 'pendiente'}
              </span>
            </td>
            <td>${o.tecnicoAsignado || '-'}</td>
            <td>${o.updatedAt ? new Date(o.updatedAt).toLocaleString('es-CO') : '-'}</td>
          </tr>
        `).join('');
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:16px; color: var(--danger);">No se pudieron cargar las órdenes.</td></tr>';
      }
    }

    loadDashboard();
  </script>
</body>
</html>
